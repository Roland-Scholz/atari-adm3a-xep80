ca65 V2.17 - Git 59ab140
Main file   : ..\src\adm3ax80.a65
Current file: ..\src\adm3ax80.a65

000000r 1               		.org $2000
002000  1               
002000  1               XEPSIO		= 1
002000  1               ;
002000  1               ;CHAR =ATES
002000  1               ;
002000  1               LF	=	10
002000  1               CR	=	13
002000  1               ESC	=	$1B
002000  1               CUP	=	28
002000  1               CDOWN	=	29
002000  1               CLEFT	=	30
002000  1               CRIGHT	=	31
002000  1               SPACE	=	$20
002000  1               CNTL	=	$5E
002000  1               CLS	=	$7D
002000  1               DELETE	=	$7E
002000  1               TABU 	=	$7F
002000  1               EOL	=	$9B
002000  1               DELIN	=	$9C
002000  1               INSLIN  =	$9D
002000  1               DELCHR  =	$FE
002000  1               INSCHR	=	$FF
002000  1               
002000  1               CSRXMAX	=	79
002000  1               CSRYMAX	=	23
002000  1               ;
002000  1               ;80 COL COMMANDS
002000  1               ;
002000  1               XCH80	=	$50
002000  1               LMG80	=	$60
002000  1               LMH80	=	$70
002000  1               YCR80	=	$80
002000  1               SGR80	=	$99
002000  1               PAG80	=	$9A
002000  1               RMG80	=	$A0
002000  1               RMH80	=	$B0
002000  1               GET80	=	$C0
002000  1               CUR80	=	$C1
002000  1               RST80	=	$C2
002000  1               PST80	=	$C3
002000  1               CLR80	=	$C4
002000  1               LIS80	=	$D0
002000  1               SCR80	=	$D2
002000  1               SCB80	=	$D3
002000  1               GRF80	=	$D4
002000  1               ICM80	=	$D5
002000  1               PAL80	=	$D7
002000  1               CRS80	=	$D9
002000  1               MCF80	=	$DB
002000  1               PNT80	=	$DD
002000  1               
002000  1               TCP80	=	$F6					;set timing control pointer
002000  1               TCR80	=	$F7					;set timing control register
002000  1               ;
002000  1               ;MEMORY EQUATES
002000  1               ;
002000  1               PTR	=	$0
002000  1               DOSINI	=	$0C
002000  1               ICDNOZ	=	$21
002000  1               ICCOMZ	=	$22
002000  1               ICAX1Z	=	$2A
002000  1               ICAX2Z	=	$2B
002000  1               ICIDNO	=	$2E
002000  1               LMARGN	=	$52
002000  1               RMARGN	=	$53
002000  1               VCP	=	$54
002000  1               csry		=	VCP
002000  1               csrx		=	HCP
002000  1               
002000  1               HCP	=	$55
002000  1               SAVMSC	=	$58
002000  1               KEYDEF	=	$0079
002000  1               IN	=	$CC
002000  1               VBREAK	=	$0206
002000  1               VSERIN	=	$20A
002000  1               VSEROR	=	$20C
002000  1               VIMIRQ	=	$216
002000  1               CDTMV3	=	$21C
002000  1               SDMCTL	=	$22F
002000  1               BRKKY	=	$0236
002000  1               KEYDEL	=	$2D9
002000  1               KEYREP	=	$2DA
002000  1               DVstaT	=	$2EA
002000  1               CRSINH	=	$2F0
002000  1               CHBAS	=	$2F4
002000  1               CH	=	$2FC
002000  1               LISTF	=	$2FE
002000  1               SFLAG	=	$2FF
002000  1               HATABS	=	$31A
002000  1               ICDNO	=	$341
002000  1               PAL	=	$D014
002000  1               PORTA	=	$D300
002000  1               PACTL	=	$D302
002000  1               DMACTL	=	$D400
002000  1               WSYNC	=	$D40A
002000  1               VCOUNT	=	$D40B
002000  1               NMIEN	=	$D40E
002000  1               
002000  1               IMBRK	=	$80
002000  1               IMKBD	=	$40
002000  1               IMRECV	=	$20
002000  1               IMSEND	=	$10
002000  1               IMSCPL	=	$08
002000  1               
002000  1               RMBRK	=	$7F
002000  1               RMKEY	=	$BF
002000  1               RMRECV	=	$DF
002000  1               RMSEND	=	$EF
002000  1               
002000  1               MSKKEY	=	$40
002000  1               MSKRECV	=	$20
002000  1               MSKSEND	=	$10
002000  1               
002000  1               SKSEND	=	$23
002000  1               SKRECV	=	$13
002000  1               
002000  1               POKMSK	=	$10
002000  1               
002000  1               CONSOL	=	$D01F	;console switches and speaker control
002000  1               
002000  1               AUDF1	=	$D200
002000  1               AUDC1	=	$D201
002000  1               AUDF2	=	$D202
002000  1               AUDC2	=	$D203
002000  1               AUDF3	=	$D204
002000  1               AUDC3	=	$D205
002000  1               AUDF4	=	$D206
002000  1               AUDC4	=	$D207
002000  1               AUDCTL	=	$D208
002000  1               KBCODE	=	$D209
002000  1               SKRES	=	$D20A
002000  1               SERIN	=	$D20D
002000  1               SEROUT	=	$D20D
002000  1               IRQEN	=	$D20E
002000  1               IRQST	=	$D20E
002000  1               SKCTL	=	$D20F
002000  1               SKSTAT	=	$D20F
002000  1               
002000  1               COLDSV	=	$E477
002000  1               
002000  1               ATACHR	=	$2FB
002000  1               KBCODES	=	$2FC
002000  1               
002000  1               
002000  1               DDEVIC	=	$300
002000  1               DUNIT	=	$301
002000  1               DCOMND	=	$302
002000  1               DSTATS	=	$303
002000  1               DBUFLO	=	$304
002000  1               DBUFHI	=	$305
002000  1               DTIMLO	=	$306
002000  1               DBYTLO	=	$308
002000  1               DBYTHI	=	$309
002000  1               DAUX1	=	$30A
002000  1               DAUX2	=	$30B
002000  1               
002000  1               DISKV	=	$E453
002000  1               CIOV	=	$E456
002000  1               SIOV	=	$E459
002000  1               COPEN	=	03
002000  1               CGETR	=	7
002000  1               CPTXTR	=	9
002000  1               CPUTR	=	11
002000  1               CCLOSE	=	12
002000  1               
002000  1               CBAUD	=	36
002000  1               CTRANS	=	38
002000  1               CCONCUR	=	40
002000  1               
002000  1               ICCOM	=	$342
002000  1               ICBADR	=	$344
002000  1               ICBLEN	=	$348
002000  1               ICAUX1	=	$34A
002000  1               ICAUX2	=	$34B
002000  1               
002000  1               ;============================================================
002000  1               ; time-dependent code (cycle-counting) in one page!
002000  1               ;============================================================
002000  1  4C 5E 21     asm3axep:	jmp	start				;jump to main loop
002003  1               
002003  1  4C 69 20     OUTPUT:		jmp	XOUTPUT
002006  1  4C 66 20     CMD:		jmp	XCMD
002009  1  20 06 20     CINP:		jsr	CMD
00200C  1  A9 00        INPUT:		lda	#00				;TIME CRITICAL CODE
00200E  1  AA           		tax					;MUST NOT CROSS A
00200F  1  A0 1F        		ldy	#31				;PAGE BOUNDARY
002011  1  8D D8 25     		sta	DATIN
002014  1  AD 00 D3     IN0:		lda 	PORTA 				;4
002017  1  2D D9 25     		and	INMSK 				;4
00201A  1  F0 08        		beq	IN01				;3 IF A 0, 2 IF NOT
00201C  1  CA           		dex
00201D  1  D0 F5        		bne	IN0
00201F  1  88           		dey					;TIMEOUT LOOPS
002020  1  D0 F2        		bne	IN0
002022  1  38           		sec					;NO RESPONSE
002023  1  60           		rts
002024  1  A2 08        IN01:		ldx	#08
002026  1  A0 0C        		ldy	#12				;2
002028  1  88           IN1:		dey
002029  1  D0 FD        		bne	IN1				;5*Y-1
00202B  1  EA           		nop					;2
00202C  1  A0 0F        IN10:		ldy	#15				;2 MAIN DLY COUNT
00202E  1  88           IN2:		dey
00202F  1  D0 FD        		bne	IN2				;5*Y-1
002031  1  AD 00 D3     		lda	PORTA				;4 GET BYTE
002034  1  2D D9 25     		and	INMSK				;4 GET BIT
002037  1  18           		clc					;2
002038  1  F0 01        		beq	IN25				;0=3,1=2
00203A  1  38           		sec					;1=2
00203B  1  90 00        IN25:		bcc	IN26				;0=3,1=2
00203D  1  CA           IN26:		dex					;2 DEC COUNT
00203E  1  30 05        		bmi	IN3				;2 (3 DONE)
002040  1  6E D8 25     		ror	DATIN				;6 SHIFT IN BIT
002043  1  90 E7        		bcc	IN10				;3 ALWAYS
002045  1  A0 0F        IN3:		ldy	#15				;DELAY 1/2 BIT
002047  1  88           IN33:		dey
002048  1  D0 FD        		bne	IN33
00204A  1  AD D8 25     		lda	DATIN				;GET CHAR (Y=0)
00204D  1  90 16        		bcc	I5				;RETURN IF CHAR
00204F  1  10 0F        		bpl	I0				;HORIZ WITH NO VERT
002051  1  29 7F        		and	#$7F				;CLEAR UPPER FLAG
002053  1  C9 51        		cmp	#$51				;TEST HORIZ/VERT
002055  1  90 04        		bcc	I00 				;HORIZONTAL
002057  1  29 1F        		and	#$1F				;CLEAR MID FLAG
002059  1  B0 06        		bcs	I01				;SAVE VERT
00205B  1  20 60 20     I00:		jsr	I0				;SAVE HORIZ
00205E  1  90 AC        		bcc	INPUT				;GET VERT
002060  1  C8           I0:		iny					;OFFSET FOR HORIZ
002061  1  99 54 00     I01:		sta	VCP,Y				;CURS POSITION
002064  1               ;		sta	VCS,Y				;CURS SHADOW
002064  1  18           		clc					;INDICATE RESPONSE
002065  1  60           I5:		rts
002066  1               
002066  1               
002066  1               ;
002066  1  38           XCMD: 		sec 					;THIS CODE MUST NOT
002067  1  B0 01        		bcs 	OUT 				;CROSS A PAGE BOUNDARY
002069  1  18           XOUTPUT:	clc 					;CMD FLAG=0 FOR CHAR
00206A  1  A0 00        OUT: 		ldy 	#00
00206C  1               
00206C  1  20 CA 25     		jsr	DISAB
00206F  1  20 9B 20     		jsr 	SEND				;SEND staRT BIT
002072  1               
002072  1  A2 08        		ldx 	#08				;SETUP BIT COUNT OF 9
002074  1  EA           		nop
002075  1  EA           		nop
002076  1  EA           		nop					;2+2+2+2=8
002077  1  6A           OUT0:		ror 	A				;2 PUT BIT INTO CARRY
002078  1  B0 09        		bcs 	HI
00207A  1  90 00        		bcc 	LO				;2+3=5 CYCLES TO LO
00207C  1  A0 00        LO:		ldy 	#00				;5+2 CYCLES TO JSR
00207E  1  20 9B 20     		jsr 	SEND				;SEND A 0
002081  1  90 08        		bcc 	OUT1				;3 CYCLES
002083  1  AC DA 25     HI:		ldy 	OUTMS				;3+4 CYCLES TO JSR
002086  1  20 9B 20     		jsr 	SEND				;SEND A 1
002089  1  B0 00        		bcs 	OUT1				;3 CYCLES
00208B  1  CA           OUT1:		dex					;NEXT BIT 2 CYC
00208C  1  10 E9        		bpl 	OUT0				;MORE 3 OR 2 CYC
00208E  1  30 00        		bmi 	OUT2				;SEND STOP BIT 3 CYC
002090  1  AC DA 25     OUT2:		ldy 	OUTMS				;SEND A 1
002093  1  D0 00        		bne 	OUT3
002095  1  20 9B 20     OUT3:		jsr 	SEND				;2+3+4+3=12
002098  1               
002098  1  4C D1 25     		jmp	ENAB
00209B  1               
00209B  1               
00209B  1  8C 00 D3     SEND:		sty 	PORTA				;OUTPUT BIT
00209E  1  A0 0C        		ldy 	#12				;TIMER FOR 15.7KB
0020A0  1  88           S1:		dey
0020A1  1  D0 FD        		bne 	S1				;5*Y-1 CYCLES
0020A3  1  F0 00        		beq 	S2				;3
0020A5  1  EA           S2:		nop
0020A6  1  EA           		nop
0020A7  1  EA           		nop
0020A8  1  EA           		nop					;2+2+2+2=8
0020A9  1  60           S3:		rts					;6 CYCLES
0020AA  1               
0020AA  1               
0020AA  1               
0020AA  1               
0020AA  1  38           siocmd: 	sec 					;THIS CODE MUST NOT
0020AB  1  B0 01        		bcs 	SOUT 				;CROSS A PAGE BOUNDARY
0020AD  1  18           sioout:		clc 					;CMD FLAG=0 FOR CHAR
0020AE  1  A0 3C        SOUT: 		ldy 	#$3c				;1, will be inverted, hence 0
0020B0  1               
0020B0  1  20 CA 25     		jsr	DISAB
0020B3  1  20 DD 20     		jsr 	SIOSEND				;SEND staRT BIT
0020B6  1               
0020B6  1  A2 08        		ldx 	#08				;SETUP BIT COUNT OF 9
0020B8  1  EA           		nop
0020B9  1  EA           		nop
0020BA  1  EA           		nop					;2+2+2+2=8
0020BB  1  6A           SOUT0:		ror 	A				;2 PUT BIT INTO CARRY
0020BC  1  B0 09        		bcs 	SHI				;3
0020BE  1  90 00        		bcc 	SLO				;2+3=5 CYCLES TO LO
0020C0  1  A0 3C        SLO:		ldy 	#$3c				;5+2 CYCLES TO JSR
0020C2  1  20 DD 20     		jsr 	SIOSEND				;6 + 82 SEND A 0
0020C5  1  90 07        		bcc 	SOUT1				;3 CYCLES
0020C7  1  A0 34        SHI:		ldy 	#$34				;2 SOUTMS		;3+4 CYCLES TO JSR
0020C9  1  20 DD 20     		jsr 	SIOSEND				;6 + 82 SEND A 1
0020CC  1  B0 00        		bcs 	SOUT1				;3 CYCLES
0020CE  1  CA           SOUT1:		dex					;2 NEXT BIT 2 CYC
0020CF  1  10 EA        		bpl 	SOUT0				;3 MORE 3 OR 2 CYC
0020D1  1  30 00        		bmi 	SOUT2				;SEND STOP BIT 3 CYC
0020D3  1  A0 34        SOUT2:		ldy 	#$34				;SOUTMS		;SEND A 1
0020D5  1  D0 00        		bne 	SOUT3
0020D7  1  20 DD 20     SOUT3:		jsr 	SIOSEND				;2+3+4+3=12
0020DA  1               
0020DA  1  4C D1 25     		jmp	ENAB
0020DD  1               
0020DD  1               
0020DD  1  8C 02 D3     SIOSEND:	sty 	PACTL				;4 OUTPUT BIT
0020E0  1  A0 0C        		ldy 	#12				;2 TIMER FOR 15.7KB
0020E2  1  88           SIOS1:		dey
0020E3  1  D0 FD        		bne 	SIOS1				;5*Y-1 CYCLES
0020E5  1  F0 00        		beq 	SIOS2				;3
0020E7  1  EA           SIOS2:		nop
0020E8  1  EA           		nop
0020E9  1  EA           		nop
0020EA  1  EA           		nop					;2+2+2+2=8
0020EB  1  60           SIOS3:		rts					;6 CYCLES, = 82
0020EC  1               
0020EC  1               ;============================================================
0020EC  1               ; bittime, wait some time
0020EC  1               ;============================================================
0020EC  1  A2 0B        bittime:	ldx	#11				;2
0020EE  1  CA           bittime1:	dex					;x * (2+3) = 11*5 = 55
0020EF  1  D0 FD        		bne	bittime1
0020F1  1  60           		rts					;6, 8+55=63
0020F2  1               
0020F2  1               ;============================================================
0020F2  1               ; SIO XEP80 input routine
0020F2  1               ;============================================================
0020F2  1  20 AA 20     siocinp:	jsr	siocmd
0020F5  1  A9 34        sioinput:	lda	#$34				;wait for low-edge
0020F7  1  8D 02 D3     		sta	PACTL
0020FA  1  A0 1F        		ldy	#31
0020FC  1  A2 00        		ldx	#0
0020FE  1               
0020FE  1  AD 02 D3     sioin1:		lda	PACTL
002101  1  30 08        		bmi	sioin2				;got low-edge
002103  1  CA           		dex
002104  1  D0 F8        		bne	sioin1
002106  1  88           		dey
002107  1  D0 F5        		bne	sioin1
002109  1  38           		sec
00210A  1  60           		rts
00210B  1               
00210B  1  AD 00 D3     sioin2:		lda	PORTA				;4 reset IRQA1 bit
00210E  1               
00210E  1  A9 36        		lda	#$36				;2 set rising edge detect
002110  1  8D 02 D3     		sta	PACTL				;4
002113  1  20 EC 20     		jsr	bittime				;6
002116  1               
002116  1  A0 09        		ldy	#9				;input 9 bits
002118  1               
002118  1  20 EC 20     sioin3:		jsr	bittime				;6 + 63 = 69
00211B  1  AD 02 D3     		lda	PACTL				;3
00211E  1  30 0F        		bmi	sioin4				;3 or 2 = 75
002120  1               
002120  1  49 02        		eor	#2				;2
002122  1  4A           		lsr					;2
002123  1  4A           		lsr					;2
002124  1  6E D8 25     		ror	DATIN				;6 shiftin 0
002127  1  A5 00        		lda	$0				;3
002129  1  EA           		nop
00212A  1  EA           		nop
00212B  1  EA           		nop					;9 = 3 + 3*2
00212C  1  4C 3F 21     		jmp	sioin5				;3
00212F  1               
00212F  1  4A           sioin4:		lsr					;2 put edge-detect in carry
002130  1  4A           		lsr					;2
002131  1  6E D8 25     		ror	DATIN				;6 shift in datin
002134  1  AD 00 D3     		lda	PORTA				;4 reset IRQA bit
002137  1  AD 02 D3     		lda	PACTL				;4 check other edge
00213A  1  49 02        		eor	#2				;2
00213C  1  8D 02 D3     		sta	PACTL				;4
00213F  1               							;24 + 75 = 99
00213F  1  88           sioin5:		dey					;2
002140  1  D0 D6        		bne	sioin3				;3
002142  1               							; loop = 99 + 5 = 104
002142  1  2E D8 25     		rol	DATIN
002145  1  90 16        		bcc	sioin9				;character data
002147  1  10 0F        		bpl	sioin6				;HORIZ WITH NO VERT
002149  1  29 7F        		and	#$7F				;CLEAR UPPER FLAG
00214B  1  C9 51        		cmp	#$51				;TEST HORIZ/VERT
00214D  1  90 04        		bcc	sioin7 				;HORIZONTAL
00214F  1  29 1F        		and	#$1F				;CLEAR MID FLAG
002151  1  B0 06        		bcs	sioin8				;SAVE VERT
002153  1  20 58 21     sioin7:		jsr	sioin6				;SAVE HORIZ
002156  1  90 9D        		bcc	sioinput			;GET VERT
002158  1  C8           sioin6:		iny					;OFFSET FOR HORIZ
002159  1  99 54 00     sioin8:		sta	VCP,Y				;CURS POSITION
00215C  1               ;		sta	VCS,Y				;CURS SHADOW
00215C  1  18           		clc					;INDICATE RESPONSE
00215D  1  60           sioin9:		rts
00215E  1               ;============================================================
00215E  1               ; actual start of program
00215E  1               ;============================================================
00215E  1  20 B4 24     start:		jsr	geoutch
002161  1               
002161  1  20 99 25     		jsr	CINIT
002164  1  20 57 25     		jsr 	EOPEN
002167  1  90 18        		bcc	eopenok				;carry-clear, got response
002169  1               
002169  1  A9 22        		lda	#$22				;no response, show message and reset
00216B  1  8D 2F 02     		sta	SDMCTL				;switch normal DMA on
00216E  1               
00216E  1  A9 94        		lda	#<noxep80			;if no XEP present
002170  1  8D 44 03     		sta	ICBADR				;display message
002173  1  A9 26        		lda	#>noxep80
002175  1  8D 45 03     		sta	ICBADR+1
002178  1  20 C5 24     		jsr	println
00217B  1  20 27 25     		jsr	KCALL				;wait for key
00217E  1  4C 77 E4     		jmp	COLDSV				;reset
002181  1               
002181  1               
002181  1  20 41 22     eopenok:	jsr	resetsally
002184  1               
002184  1  78           		sei					;set own serin IRQ routine
002185  1  A9 A5        		lda	#<serinirq
002187  1  8D 0A 02     		sta	VSERIN
00218A  1  A9 22        		lda	#>serinirq
00218C  1  8D 0B 02     		sta	VSERIN+1
00218F  1  A9 B7        		lda	#<breakirq
002191  1  8D 36 02     		sta	BRKKY
002194  1  A9 22        		lda	#>breakirq
002196  1  8D 37 02     		sta	BRKKY+1
002199  1  20 6B 22     		jsr	SETPOKY				;reprogram POKEY for 9600 baud duplex
00219C  1  58           		cli
00219D  1               
00219D  1  20 60 24     		jsr	clearvars
0021A0  1               
0021A0  1  A9 02        		lda	#<welcome			;print welcome message
0021A2  1  85 00        		sta	PTR
0021A4  1  A9 26        		lda	#>welcome
0021A6  1  85 01        		sta	PTR+1
0021A8  1  20 D8 24     		jsr	printadm
0021AB  1               
0021AB  1  20 C3 22     		jsr	time				;send CR (POKEY code)
0021AE  1  A9 0C        		lda	#$0c
0021B0  1  8D FC 02     		sta	CH
0021B3  1               
0021B3  1               
0021B3  1               ;============================================================
0021B3  1               ; main loop
0021B3  1               ;============================================================
0021B3  1  20 C6 21     main:		jsr	getkey
0021B6  1  F0 03        		beq	main1
0021B8  1               
0021B8  1  8D 0D D2     		sta	SEROUT
0021BB  1               
0021BB  1  20 31 22     main1:		jsr	serin
0021BE  1  F0 F3        		beq	main
0021C0  1               
0021C0  1  20 D4 22     main2:		jsr	adm3aput
0021C3  1               
0021C3  1  4C B3 21     		jmp	main
0021C6  1               
0021C6  1               ;============================================================
0021C6  1               ; get key and translate to ASCII
0021C6  1               ;============================================================
0021C6  1  AC FC 02     getkey:		ldy	CH
0021C9  1  C0 FF        		cpy	#$ff
0021CB  1  D0 03        		bne	getkey0
0021CD  1               
0021CD  1  A9 00        myirqkey10:	lda	#0
0021CF  1  60           		rts
0021D0  1               
0021D0  1  A2 FF        getkey0:	ldx	#$ff
0021D2  1  8E FC 02     		stx	CH
0021D5  1               
0021D5  1  C0 C0        		cpy	#$C0				;only 192 bytes in key-table
0021D7  1  B0 F4        		bcs	myirqkey10
0021D9  1               
0021D9  1  20 1F 22     		jsr	skc				;sound key click
0021DC  1               
0021DC  1  B1 79        		lda	(KEYDEF),y
0021DE  1               
0021DE  1  C9 61        		cmp	#'a'
0021E0  1  90 06        		bcc	getkey1
0021E2  1  C9 7B        		cmp	#'z'+1
0021E4  1  B0 02        		bcs	getkey1
0021E6  1  E9 1F        		sbc	#31
0021E8  1               
0021E8  1  C9 9B        getkey1:	cmp	#EOL				;EOL $9b -> CR $0d
0021EA  1  D0 02        		bne	getkey2
0021EC  1  A9 0D        		lda	#CR
0021EE  1  C9 7D        getkey2:	cmp	#CLS
0021F0  1  D0 02        		bne	getkey3
0021F2  1  A9 1E        		lda	#$1e				;CTRL-<
0021F4  1  C9 FF        getkey3:	cmp	#$ff
0021F6  1  D0 02        		bne	getkey4
0021F8  1  A9 1F        		lda	#$1f				;CTRL->
0021FA  1  C9 7F        getkey4:	cmp	#TABU				;TABU $7f -> $09
0021FC  1  D0 02        		bne	getkey5
0021FE  1  A9 09        		lda	#$09
002200  1  C9 1E        getkey5:	cmp	#CLEFT
002202  1  D0 02        		bne	getkey6
002204  1  A9 08        		lda	#$08
002206  1  C9 1F        getkey6:	cmp	#CRIGHT
002208  1  D0 02        		bne	getkey7
00220A  1  A9 0C        		lda	#$0c
00220C  1  C9 1C        getkey7:	cmp	#CUP
00220E  1  D0 02        		bne	getkey8
002210  1  A9 0B        		lda	#$0b
002212  1  C9 1D        getkey8:	cmp	#CDOWN
002214  1  D0 02        		bne	getkey9
002216  1  A9 0A        		lda	#$0a
002218  1  C9 7E        getkey9:	cmp	#DELETE
00221A  1  D0 02        		bne	getkeyex
00221C  1  A9 08        		lda	#$08
00221E  1  60           getkeyex:	rts
00221F  1               
00221F  1               
00221F  1               
00221F  1               ;============================================================
00221F  1               ; sound key click A,X destroyed
00221F  1               ;============================================================
00221F  1  A2 7E        skc:		ldx	#2*63				;2 times trip count
002221  1               
002221  1  8E 1F D0     SKC1:		stx	CONSOL				;turn loudspeaker on
002224  1  AD 0B D4     		lda	VCOUNT				;vertical line counter
002227  1  CD 0B D4     SKC2:		cmp	VCOUNT				;current vertical line counter
00222A  1  F0 FB        		beq	SKC2				;if vertical line not changed
00222C  1  CA           		dex
00222D  1  CA           		dex
00222E  1  10 F1        		bpl	SKC1				;if not done
002230  1  60           		rts					;return
002231  1               
002231  1               
002231  1               
002231  1               serin:
002231  1  AE FD 25     		ldx	bufstart
002234  1  EC FE 25     		cpx	bufend
002237  1  F0 07        		beq	serinex
002239  1               
002239  1  E8           		inx
00223A  1  8E FD 25     		stx	bufstart
00223D  1  BD B5 26     		lda	buffer,x
002240  1               
002240  1  60           serinex:	rts
002241  1               
002241  1               
002241  1               ;============================================================
002241  1               ; reset the ATR8000 / Sally interface
002241  1               ;============================================================
002241  1               resetsally:
002241  1  A9 5A        		lda	#'Z'				;send 'G $F000' to Z:-device
002243  1  8D 00 03     		sta	DDEVIC				;which is a reset
002246  1  A9 01        		lda	#$01
002248  1  8D 01 03     		sta	DUNIT
00224B  1  8D 06 03     		sta	DTIMLO
00224E  1  A9 47        		lda	#'G'
002250  1  8D 02 03     		sta	DCOMND
002253  1  A9 00        		lda	#$00
002255  1  8D 0A 03     		sta	DAUX1
002258  1  A9 F0        		lda	#$F0
00225A  1  8D 0B 03     		sta	DAUX2
00225D  1  A9 00        		lda	#$00
00225F  1  8D 03 03     		sta	DSTATS
002262  1  8D 08 03     		sta	DBYTLO
002265  1  8D 09 03     		sta	DBYTHI
002268  1  4C 59 E4     		jmp	SIOV
00226B  1               
00226B  1               ;============================================================
00226B  1               ; serial routines
00226B  1               ;============================================================
00226B  1  A9 55        SETPOKY:	lda 	#85				;BAUD	9600
00226D  1  8D 00 D2     		sta 	AUDF1
002270  1  8D 04 D2     		sta 	AUDF3
002273  1  A9 00        		lda 	#$0
002275  1  8D 02 D2     		sta 	AUDF2
002278  1  8D 06 D2     		sta 	AUDF4
00227B  1               
00227B  1  A9 78        		lda 	#$78
00227D  1  8D 08 D2     		sta 	AUDCTL
002280  1  A9 A0        		lda 	#$A0
002282  1  8D 01 D2     		sta 	AUDC1
002285  1  8D 03 D2     		sta 	AUDC2
002288  1  8D 05 D2     		sta 	AUDC3
00228B  1  8D 07 D2     		sta 	AUDC4
00228E  1  A9 73        		lda 	#$73
002290  1  8D 0F D2     		sta 	SKCTL
002293  1               
002293  1  A9 00        		lda 	#0
002295  1  8D 0E D2     		sta 	IRQEN
002298  1  8D 0A D2     		sta	SKRES
00229B  1               
00229B  1  A5 10        		lda	POKMSK
00229D  1  09 A0        		ora	#IMRECV+IMBRK
00229F  1  85 10        		sta 	POKMSK
0022A1  1  8D 0E D2     		sta 	IRQEN
0022A4  1               
0022A4  1  60           		rts
0022A5  1               
0022A5  1               ;============================================================
0022A5  1               ; serial-in IRQ routine
0022A5  1               ;============================================================
0022A5  1  98           serinirq:	tya
0022A6  1  48           		pha
0022A7  1               
0022A7  1  AD 0D D2     myirq1:		lda	SERIN
0022AA  1               
0022AA  1  EE FE 25     myirq2:		inc	bufend
0022AD  1  AC FE 25     		ldy	bufend
0022B0  1  99 B5 26     		sta	buffer,y
0022B3  1               
0022B3  1  68           myirqex:	pla
0022B4  1  A8           		tay
0022B5  1  68           		pla
0022B6  1  40           		rti
0022B7  1               
0022B7  1               ;============================================================
0022B7  1               ;  break IRQ routine
0022B7  1               ;============================================================
0022B7  1  68           breakirq:	pla
0022B8  1  68           		pla
0022B9  1  68           		pla
0022BA  1  68           		pla
0022BB  1               
0022BB  1  A9 20        		lda	#>asm3axep
0022BD  1  48           		pha
0022BE  1  A9 00        		lda	#<asm3axep
0022C0  1  48           		pha
0022C1  1  48           		pha
0022C2  1  40           		rti
0022C3  1               ;============================================================
0022C3  1               ; wait some time before sending CR
0022C3  1               ;============================================================
0022C3  1  A9 0C        time:		lda	#12
0022C5  1  A0 00        		ldy	#0
0022C7  1  A2 00        		ldx	#0
0022C9  1  CA           time1:		dex
0022CA  1  D0 FD        		bne	time1
0022CC  1  88           		dey
0022CD  1  D0 FA        		bne	time1
0022CF  1  E9 01        		sbc	#1
0022D1  1  D0 F6        		bne	time1
0022D3  1  60           		rts
0022D4  1               
0022D4  1               ;============================================================
0022D4  1               ; ADM-3A output routines
0022D4  1               ;============================================================
0022D4  1  29 7F        adm3aput:	and	#127				;clear bit 7
0022D6  1               
0022D6  1  AE DB 23     		ldx	direct
0022D9  1  D0 1C        		bne	decode4
0022DB  1               
0022DB  1  C9 20        		cmp	#32				;<space = control char?
0022DD  1  90 5F        		bcc	ctrl
0022DF  1               
0022DF  1  AE F8 25     		ldx	escflag				;last key ESC?
0022E2  1  F0 03        		beq	decode1				;no, check other flags
0022E4  1  4C DF 23     		jmp	decodeesc			;do ESC stuff
0022E7  1               
0022E7  1  2C FB 25     decode1:	bit	cflag
0022EA  1  70 3F        		bvs	getcsry
0022EC  1  30 2C        		bmi	getcsrx
0022EE  1               
0022EE  1  C9 7D        decode3:	cmp	#$7d				;mask out 7d-7f
0022F0  1  90 02        		bcc	decode5
0022F2  1  A9 20        		lda	#' '
0022F4  1               
0022F4  1  0D FA 25     decode5:	ora	hibit
0022F7  1               
0022F7  1  20 03 20     decode4:	jsr	OUTPUT				;print char and fall through
0022FA  1               
0022FA  1  A9 00        		lda	#0
0022FC  1  8D F8 25     		sta	escflag
0022FF  1  8D FB 25     		sta	cflag
002302  1  8D DB 23     		sta	direct
002305  1               
002305  1  E6 55        advancex:	inc	csrx				;increment xpos
002307  1  A6 55        		ldx	csrx
002309  1  E0 50        		cpx	#CSRXMAX+1			;if less then max+1 (80)
00230B  1  90 0C        		bcc	advance1			;quit
00230D  1               
00230D  1  A2 00        		ldx	#0				;else reset
00230F  1  86 55        		stx	csrx
002311  1  A6 54        advancey:	ldx	<csry				;and increment y
002313  1  E0 17        		cpx	#CSRYMAX			;if less than 23
002315  1  90 02        		bcc	advance1
002317  1  E6 54        		inc	csry
002319  1  60           advance1:	rts
00231A  1               
00231A  1               
00231A  1               ;============================================================
00231A  1               ; ESC = 'column'+32 'row'+32
00231A  1               ;============================================================
00231A  1  0E FB 25     getcsrx:	asl	cflag
00231D  1               
00231D  1  38           		sec
00231E  1  E9 20        		sbc	#32
002320  1  85 55        		sta	csrx
002322  1  C9 50        		cmp	#CSRXMAX+1
002324  1  90 02        		bcc	getcsrx1
002326  1  A9 00        		lda	#0
002328  1  4C 06 20     getcsrx1:	jmp	CMD
00232B  1               
00232B  1  0E FB 25     getcsry:	asl	cflag
00232E  1               
00232E  1  38           		sec
00232F  1  E9 20        		sbc	#32
002331  1  85 54        		sta	csry
002333  1  C9 18        		cmp	#CSRYMAX+1
002335  1  90 02        		bcc	getcsry1
002337  1  A9 00        		lda	#0
002339  1  09 80        getcsry1:	ora	#128
00233B  1  4C 06 20     		jmp	CMD
00233E  1               
00233E  1               
00233E  1               ;============================================================
00233E  1               ; process ADM-3A control codes
00233E  1               ;============================================================
00233E  1  AE 73 24     ctrl:		ldx	ctrlnum				;search control table
002341  1  DD 74 24     ctrl1:		cmp	ctrltab,x
002344  1  F0 04        		beq	ctrlfound			;found, process control code
002346  1  CA           		dex
002347  1  10 F8        		bpl	ctrl1
002349  1  60           		rts					;if not found, return
00234A  1               
00234A  1  A8           ctrlfound:	tay
00234B  1  8A           		txa
00234C  1  0A           		asl
00234D  1  AA           		tax
00234E  1  BD 7F 24     		lda	ctrladr+1,x
002351  1  48           		pha
002352  1  BD 7E 24     		lda	ctrladr,x
002355  1  48           		pha
002356  1  60           		rts
002357  1               
002357  1               
002357  1  A5 55        csrleft:	lda	csrx
002359  1  D0 01        		bne	csrleft1
00235B  1  60           		rts
00235C  1  C6 55        csrleft1:	dec	csrx
00235E  1  A9 1E        		lda	#CLEFT
002360  1  4C 03 20     		jmp	OUTPUT
002363  1               
002363  1  A5 55        tabul:		lda	csrx
002365  1  C9 48        		cmp	#72
002367  1  90 01        		bcc	tabul1
002369  1  60           		rts
00236A  1               
00236A  1  E6 55        tabul1:		inc	csrx
00236C  1  A9 1F        		lda	#CRIGHT
00236E  1  20 03 20     		jsr	OUTPUT
002371  1  A5 55        		lda	csrx
002373  1  29 07        		and	#$7
002375  1  D0 F3        		bne	tabul1
002377  1  60           		rts
002378  1               
002378  1  A5 54        csrdown:	lda	csry
00237A  1  C9 17        		cmp	#CSRYMAX
00237C  1  B0 07        		bcs	csrdown1
00237E  1  E6 54        		inc	csry
002380  1  A9 1D        		lda	#CDOWN
002382  1  4C 03 20     		jmp	OUTPUT
002385  1               
002385  1  A9 9B        csrdown1:	lda	#EOL
002387  1  20 03 20     		jsr	OUTPUT
00238A  1  A5 55        		lda	csrx
00238C  1  4C 06 20     		jmp	CMD
00238F  1               
00238F  1  A5 54        csrup:		lda	csry
002391  1  D0 03        		bne	csrup1
002393  1  4C 15 24     		jmp	insline
002396  1               
002396  1  C6 54        csrup1:		dec	csry
002398  1  A9 1C        		lda	#CUP
00239A  1  4C 03 20     		jmp	OUTPUT
00239D  1               
00239D  1  A5 55        csrright:	lda	csrx
00239F  1  C9 4F        		cmp	#CSRXMAX
0023A1  1  90 01        		bcc	csrright1
0023A3  1  60           		rts
0023A4  1  E6 55        csrright1:	inc	csrx
0023A6  1  A9 1F        		lda	#CRIGHT
0023A8  1  4C 03 20     		jmp	OUTPUT
0023AB  1               
0023AB  1  A9 00        csrnl:		lda	#0
0023AD  1  85 55        		sta	csrx
0023AF  1  20 11 23     		jsr	advancey
0023B2  1  A9 9B        		lda	#EOL
0023B4  1  60           		rts
0023B5  1               
0023B5  1  A9 00        csrret:		lda	#0
0023B7  1  85 55        		sta	csrx
0023B9  1  4C 06 20     		jmp	CMD
0023BC  1               
0023BC  1  A9 00        clrscr:		lda	#0
0023BE  1  85 55        		sta	csrx
0023C0  1  85 54        		sta	csry
0023C2  1  A9 7D        		lda	#CLS
0023C4  1  4C 03 20     		jmp	OUTPUT
0023C7  1               
0023C7  1  A9 01        escape:		lda	#1
0023C9  1  8D F8 25     		sta	escflag
0023CC  1  60           		rts
0023CD  1               
0023CD  1  A9 00        csrhome:	lda	#0
0023CF  1  85 55        		sta	csrx
0023D1  1  85 54        		sta	csry
0023D3  1  20 06 20     		jsr	CMD				;reset X-pos
0023D6  1  A9 80        		lda	#YCR80
0023D8  1  4C 06 20     		jmp	CMD
0023DB  1               
0023DB  1  EE F9 25     direct:		inc	dflag
0023DE  1  60           		rts
0023DF  1               
0023DF  1               ;
0023DF  1               ;
0023DF  1               ;
0023DF  1  CE F8 25     decodeesc:	dec	escflag
0023E2  1  AE 92 24     		ldx	escnum
0023E5  1  DD 93 24     decesc1:	cmp	esctab,x
0023E8  1  F0 04        		beq	escfound
0023EA  1  CA           		dex
0023EB  1  10 F8        		bpl	decesc1
0023ED  1  60           		rts
0023EE  1               
0023EE  1  A8           escfound:	tay
0023EF  1  8A           		txa
0023F0  1  0A           		asl
0023F1  1  AA           		tax
0023F2  1  BD 9F 24     		lda	escadr+1,x
0023F5  1  48           		pha
0023F6  1  BD 9E 24     		lda	escadr,x
0023F9  1  48           		pha
0023FA  1  60           		rts
0023FB  1               
0023FB  1  A9 00        disattr:	lda	#0
0023FD  1  8D FA 25     disattr1:	sta	hibit
002400  1  60           		rts
002401  1               
002401  1  A9 80        enaattr:	lda	#$80
002403  1  D0 F8        		bne	disattr1
002405  1               
002405  1  A9 FF        setinv:		lda	#$FF
002407  1  20 03 20     		jsr	OUTPUT
00240A  1  A9 F5        		lda	#$F5
00240C  1  4C 06 20     		jmp	CMD
00240F  1               
00240F  1  A9 C0        csrpos:		lda	#$c0
002411  1  8D FB 25     		sta	cflag
002414  1  60           		rts
002415  1               
002415  1               
002415  1  A9 9D        insline:	lda	#INSLIN
002417  1  20 03 20     insline1:	jsr	OUTPUT
00241A  1  A5 55        insline2:	lda	csrx
00241C  1  4C 06 20     		jmp	CMD
00241F  1               
00241F  1  A9 FF        inschar:	lda	#INSCHR
002421  1  4C 03 20     		jmp	OUTPUT
002424  1               
002424  1  A9 9C        delline:	lda	#DELIN
002426  1  20 03 20     		jsr	OUTPUT
002429  1  4C 1A 24     		jmp	insline2
00242C  1               
00242C  1  A9 FE        delchar:	lda	#DELCHR
00242E  1  4C 03 20     		jmp	OUTPUT
002431  1               
002431  1  A5 55        clrline:	lda	csrx
002433  1  48           		pha
002434  1  A9 20        clrline2:	lda	#32
002436  1  20 03 20     		jsr	OUTPUT
002439  1  E6 55        		inc	csrx
00243B  1  A5 55        		lda	csrx
00243D  1  C9 4F        		cmp	#CSRXMAX
00243F  1  90 F3        		bcc	clrline2
002441  1  68           		pla
002442  1  85 55        		sta	csrx
002444  1  4C 06 20     		jmp	CMD
002447  1               
002447  1               
002447  1  38           clrend:		sec
002448  1  A5 54        		lda	csry
00244A  1  E9 17        		sbc	#23
00244C  1  F0 E3        		beq	clrline
00244E  1               
00244E  1  8D FC 25     		sta	cnt
002451  1  A5 55        		lda	csrx
002453  1  A9 9C        clrend1:	lda	#DELIN
002455  1  20 03 20     		jsr	OUTPUT
002458  1  CE FC 25     		dec	cnt
00245B  1  D0 F6        		bne	clrend1
00245D  1  4C 31 24     		jmp	clrline
002460  1               
002460  1               
002460  1  A9 00        clearvars:	lda	#0
002462  1  8D FA 25     		sta	hibit
002465  1  8D F8 25     		sta	escflag
002468  1  8D F9 25     		sta	dflag
00246B  1  8D FB 25     		sta	cflag
00246E  1  85 55        		sta	csrx
002470  1  85 54        		sta	csry
002472  1  60           		rts
002473  1               ;============================================================
002473  1               ; ADM-3A debug
002473  1               ;============================================================
002473  1               ;adm3adbg:	lda	#0
002473  1               ;		jsr	CMD
002473  1               ;		lda	#24+128
002473  1               ;		jsr	CMD
002473  1               ;
002473  1               ;		lda	csrx
002473  1               ;		jsr	puthex
002473  1               ;		lda	#' '
002473  1               ;		jsr	OUTPUT
002473  1               ;		lda	csry
002473  1               ;		jsr	puthex
002473  1               ;
002473  1               ;		lda	csrx
002473  1               ;		jsr	CMD
002473  1               ;		lda	csry
002473  1               ;		ora	#128
002473  1               ;		jsr	CMD
002473  1               ;		jmp	KCALL
002473  1               
002473  1  09           ctrlnum:	.byte	9
002474  1  08 09 0A 0B  ctrltab:	.byte	8,9,10,11,12,13,26,27,30,31
002478  1  0C 0D 1A 1B  
00247C  1  1E 1F        
00247E  1  56 23 62 23  ctrladr:	.word	csrleft-1, tabul-1, csrdown-1, csrup-1
002482  1  77 23 8E 23  
002486  1  9C 23 B4 23  		.word	csrright-1, csrret-1, clrscr-1, escape-1
00248A  1  BB 23 C6 23  
00248E  1  CC 23 DA 23  		.word	csrhome-1, direct-1
002492  1               
002492  1  0A           escnum:		.byte	10
002493  1  28 29 2A 37  esctab:		.byte	"()*7=EQRWTY"
002497  1  3D 45 51 52  
00249B  1  57 54 59     
00249E  1  FA 23 00 24  escadr:		.word	disattr-1, enaattr-1
0024A2  1  BB 23 04 24  		.word	clrscr-1, setinv-1, csrpos-1, insline-1
0024A6  1  0E 24 14 24  
0024AA  1  1E 24 23 24  		.word	inschar-1, delline-1, delchar-1, clrline-1
0024AE  1  2B 24 30 24  
0024B2  1  46 24        		.word	clrend-1
0024B4  1               
0024B4  1               ;============================================================
0024B4  1               ;
0024B4  1               ;============================================================
0024B4  1  AE 06 E4     geoutch:	ldx	$E406				;CHAR PUT routine
0024B7  1  AC 07 E4     		ldy	$E407
0024BA  1  E8           		inx
0024BB  1  8E 00 26     		stx	OUTCH+1
0024BE  1  D0 01        		bne	geoutch1
0024C0  1  C8           		iny
0024C1  1  8C 01 26     geoutch1:	sty	OUTCH+2
0024C4  1  60           		rts
0024C5  1               
0024C5  1  A2 00        println:	ldx	#0
0024C7  1  A9 09        		lda	#CPTXTR
0024C9  1  9D 42 03     		sta	ICCOM,x
0024CC  1  8A           		txa
0024CD  1  9D 48 03     		sta	ICBLEN,x
0024D0  1  A9 01        		lda	#1
0024D2  1  9D 49 03     		sta	ICBLEN+1,x
0024D5  1  4C 56 E4     		jmp	CIOV
0024D8  1               
0024D8  1  A0 00        printadm:	ldy	#0
0024DA  1  B1 00        		lda	(PTR),y
0024DC  1  F0 0B        		beq	printadm1
0024DE  1  20 D4 22     		jsr	adm3aput
0024E1  1  E6 00        		inc	PTR
0024E3  1  D0 F3        		bne	printadm
0024E5  1  E6 01        		inc	PTR+1
0024E7  1  D0 EF        		bne	printadm
0024E9  1  60           printadm1:	rts
0024EA  1               
0024EA  1               
0024EA  1  A9 9B        NEWLINE:	lda	#EOL
0024EC  1  48           PRINT:		pha
0024ED  1  8A           		txa
0024EE  1  48           		pha
0024EF  1  98           		tya
0024F0  1  48           		pha
0024F1  1  BA           		tsx
0024F2  1  BD 03 01     		lda	$103,X
0024F5  1  20 FF 25     		jsr	OUTCH
0024F8  1  68           		pla
0024F9  1  A8           		tay
0024FA  1  68           		pla
0024FB  1  AA           		tax
0024FC  1  68           		pla
0024FD  1  60           		rts
0024FE  1               
0024FE  1  48           puthex:		pha
0024FF  1  8A           		txa
002500  1  48           		pha
002501  1  98           		tya
002502  1  48           		pha
002503  1               
002503  1  BA           		tsx
002504  1  BD 03 01     		lda	$103,X
002507  1  48           		pha
002508  1  4A           		lsr
002509  1  4A           		lsr
00250A  1  4A           		lsr
00250B  1  4A           		lsr
00250C  1  20 1B 25     		jsr	PUTNIB
00250F  1  68           		pla
002510  1  29 0F        		and	#$0f
002512  1  20 1B 25     		jsr	PUTNIB
002515  1               
002515  1  68           		pla
002516  1  98           		tya
002517  1  68           		pla
002518  1  AA           		tax
002519  1  68           		pla
00251A  1  60           		rts
00251B  1               
00251B  1               
00251B  1  18           PUTNIB:		clc
00251C  1  69 30        		adc	#'0'
00251E  1  C9 3A        		cmp	#'9'+1
002520  1  90 02        		bcc	PUTNIB1
002522  1  69 06        		adc	#6
002524  1               PUTNIB1:	;jmp	PRINT
002524  1  4C 03 20     		jmp	OUTPUT
002527  1               
002527  1               ;============================================================
002527  1               ;
002527  1               ;============================================================
002527  1  AD 25 E4     KCALL:		lda	$E425
00252A  1  48           		pha
00252B  1  AD 24 E4     		lda	$E424
00252E  1  48           		pha
00252F  1  60           		rts
002530  1               
002530  1  BD E0 25     FESUB: 		lda	FETAB,X
002533  1  8D 2F 02     		sta	SDMCTL
002536  1  8D 00 D4     		sta	DMACTL
002539  1  BD E1 25     		lda	FETAB+1,X
00253C  1  85 54        		sta	VCP
00253E  1  BD E2 25     		lda	FETAB+2,X
002541  1  85 55        		sta	HCP
002543  1  85 52        		sta	LMARGN
002545  1  BD E3 25     		lda	FETAB+3,X
002548  1  85 53        		sta	RMARGN
00254A  1  BD E4 25     		lda	FETAB+4,X
00254D  1  8D D9 02     		sta	KEYDEL
002550  1  BD E5 25     		lda	FETAB+5,X
002553  1  8D DA 02     		sta	KEYREP
002556  1  60           		rts
002557  1               
002557  1               ;
002557  1               ;
002557  1               ; set timing control pointer ($f6) to 4
002557  1               ; set timing control register ($f7) to 168
002557  1               ;
002557  1  A2 00        EOPEN:		ldx	#00
002559  1  20 30 25     		jsr	FESUB
00255C  1               ;		lda	ICAX1Z 				;GET AUX 1
00255C  1               ;		and	#32 				;CHECK CLEAR BIT
00255C  1               ;		bne	C005 				;DONT DO RESET
00255C  1               ;		lda	#00
00255C  1               ;		ldx	#06
00255C  1               ;C0035:		sta	VCS,X
00255C  1               ;		dex
00255C  1               ;		bpl	C0035
00255C  1               
00255C  1               ;		lda	#$E0
00255C  1               ;		sta	CHSH
00255C  1               ;		lda	#$4F
00255C  1               ;		sta	RMARGS
00255C  1               ;		sta	COMPOS
00255C  1  20 CA 25     		jsr	DISAB
00255F  1               
00255F  1  20 94 25     IO00:		jsr	resetxep
002562  1  90 1B        		bcc	IO01				;GOT IT
002564  1  20 A0 25     		jsr	JTOGL				;SWITCH PORTS
002567  1  20 94 25     		jsr	resetxep
00256A  1  90 13        		bcc	IO01				;GOT IT
00256C  1               							;not founf yet, try SIO bus
00256C  1  A2 0B        		ldx	#11
00256E  1  BD EC 25     IO00a:		lda	siohand,x
002571  1  9D 03 20     		sta	OUTPUT,x
002574  1  CA           		dex
002575  1  10 F7        		bpl	IO00a
002577  1  20 94 25     		jsr	resetxep
00257A  1  90 03        		bcc	IO01				;GOT IT
00257C  1  4C D1 25     		jmp	ENAB				;bail out carry set!
00257F  1               
00257F  1  AD 14 D0     IO01:		lda	PAL				;CHECK COMPUTER TYPE
002582  1  29 0E        		and	#$0E
002584  1  D0 05        		bne	IOP1
002586  1               
002586  1  A9 D7        		lda 	#PAL80
002588  1  20 06 20     		jsr	CMD				;SET 80 COL TO 50HZ
00258B  1               
00258B  1  A9 D3        IOP1:		lda	#SCB80				;BURST mode
00258D  1  20 06 20     		jsr	CMD
002590  1               
002590  1  18           		clc
002591  1  4C D1 25     		jmp	ENAB
002594  1               
002594  1  A9 C2        resetxep:	lda	#RST80				;RESET 80 COL
002596  1  4C 09 20     		jmp	CINP				;REQUEST, GET CHAR
002599  1               ;
002599  1               ;
002599  1               ;
002599  1  A9 00        CINIT:		lda	#00
00259B  1  8D DB 25     		sta 	TOGGLE
00259E  1  F0 08        		beq	JINIT
0025A0  1               
0025A0  1  A9 01        JTOGL:		lda	#01
0025A2  1  4D DB 25     		eor 	TOGGLE
0025A5  1  8D DB 25     		sta 	TOGGLE
0025A8  1  AE DB 25     JINIT:		ldx 	TOGGLE
0025AB  1  BC DC 25     		ldy	INMST,X
0025AE  1  8C D9 25     		sty	INMSK
0025B1  1  BC DE 25     		ldy	OUTMT,X
0025B4  1  8C DA 25     		sty	OUTMS
0025B7  1  A9 FF        		lda	#$FF
0025B9  1  8D 00 D3     		sta	PORTA
0025BC  1  A2 38        		ldx	#$38
0025BE  1  8E 02 D3     		stx	PACTL
0025C1  1  8C 00 D3     		sty	PORTA
0025C4  1               ;		ldx	#$3C
0025C4  1  A2 34        		ldx	#$34				;for SIO, output CA2=0 (inverse!)
0025C6  1  8E 02 D3     		stx	PACTL
0025C9  1  60           		rts
0025CA  1               ;
0025CA  1  A0 00        DISAB:		ldy	#00
0025CC  1  8C 0E D4     		sty	NMIEN
0025CF  1  78           		sei
0025D0  1  60           		rts
0025D1  1               ;
0025D1  1  58           ENAB:		cli
0025D2  1  A0 C0        		ldy	#$C0
0025D4  1  8C 0E D4     		sty	NMIEN
0025D7  1  60           		rts
0025D8  1               
0025D8  1               ;============================================================
0025D8  1               ; XEP80 hardware variables
0025D8  1               ;============================================================
0025D8  1  00           DATIN:		.byte	0
0025D9  1  00           INMSK:		.byte	0
0025DA  1  00           OUTMS:		.byte	0
0025DB  1  00           TOGGLE:		.byte	0
0025DC  1  02 20        INMST:		.byte	02,$20
0025DE  1  01 10        OUTMT:		.byte	01,$10
0025E0  1               
0025E0  1  00 00 00 4F  FETAB:		.byte	0,0,0,$4F,24,3
0025E4  1  18 03        
0025E6  1  3E 00 02 27  		.byte	62,0,2,39,30,6
0025EA  1  1E 06        
0025EC  1               
0025EC  1  4C AD 20     siohand:	jmp	sioout
0025EF  1  4C AA 20     		jmp	siocmd
0025F2  1  4C F2 20     		jmp	siocinp
0025F5  1  4C F5 20     		jmp	sioinput
0025F8  1               ;============================================================
0025F8  1               ; ADM-3A flags and variables
0025F8  1               ;============================================================
0025F8  1  00           escflag:	.byte	0
0025F9  1  00           dflag:		.byte	0
0025FA  1  00           hibit:		.byte	0
0025FB  1  00           cflag:		.byte	0				;flags to set cursor (ESC =)
0025FC  1  00           cnt:		.byte	0
0025FD  1               ;csrx:		.byte	0				;equated to HCP	above
0025FD  1               ;csry:		.byte	0				;equated to VCP above
0025FD  1               
0025FD  1  00           bufstart:	.byte	0				;serial-in buffer start
0025FE  1  00           bufend:		.byte	0				;serial-in buffer end
0025FF  1               
0025FF  1               ;============================================================
0025FF  1               ; jump to E:-handler put routine
0025FF  1               ;============================================================
0025FF  1  4C 00 00     OUTCH:		jmp 0
002602  1               
002602  1  41 44 4D 2D  welcome:	.byte	"ADM-3A Pi-XEP80 started, resetting ATR8000 / Sally ", CR, LF
002606  1  33 41 20 50  
00260A  1  69 2D 58 45  
002637  1  4D 69 6E 69  		.byte	"Mini-Mon prompt should appear within 2 seconds", CR, LF
00263B  1  2D 4D 6F 6E  
00263F  1  20 70 72 6F  
002667  1  42 20 2D 20  		.BYTE	"B - boot, M - modify RAM, G - goto adddress", CR, 0
00266B  1  62 6F 6F 74  
00266F  1  2C 20 4D 20  
002694  1               
002694  1  4E 6F 20 58  noxep80:	.byte	"No XEP80 present, press any key.",EOL
002698  1  45 50 38 30  
00269C  1  20 70 72 65  
0026B5  1               
0026B5  1               buffer		= *
0026B5  1               
